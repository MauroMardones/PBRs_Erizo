---
title: ''
author: ''
date: ''
output:
  word_document:
    reference_docx: TemplateWord_Erizo.docx
    toc: yes
lang: es
subtitle: ''
---

```{r llama codigos, warning=F, include=T, message=F, echo=FALSE }

library(stringr)
library(lattice)
library(ggplot2)
library(reshape)
library(dplyr)
library(ggthemes)
library(stringr)
library(knitr)
library(patchwork)

# FIGURAS
dir.Fig        <-"Figuras/"
fig            <-c("pdf","bmp")

#DIRECTORIOS
carpetabase <-getwd()
dir.0       <-carpetabase
dir.1       <-paste(dir.0,"/codigos_admb",sep="")
dir.fun     <-paste(dir.0,"/funciones/",sep="")
```

```{r}
dat.file    = "MAETXN.dat" #Cambiar despues por info actualizada y borrar esto
dat1        <- lisread(paste(dir.2,dat.file, sep='/'));
names(dat1) <- str_trim(names(dat1), side="right")
dat         <- dat1
```




```{r PRIMER PASO CORRE MODELOS BASE XN, eval=FALSE, echo=FALSE, warning=FALSE}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXN")
system("./MAETXN")

```

```{r PRIMER PASO CORRE MODELOS BASE XS, eval=FALSE, echo=FALSE, warning=FALSE}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXS")
system("./MAETXS")
```

```{r PRIMER PASO CORRE MODELOS BASE XI, eval=FALSE, echo=FALSE, warning=FALSE}
setwd(dir.1)
#para mac
system("~/admb-12.2/admb MAETXI")
system("./MAETXI")
```

```{r lee_datos, echo=F, warning=FALSE}
source(paste(dir.fun,"functions.R",sep=""))
setwd(dir.1)

# Zona X Norte
data1        <- lisread("MAETXN.dat") 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist("MAETXN.rep")
std1         <- read.table("MAETXN.std",header=T,sep="",na="NA",fill=T) 

# Zona X Sur
data2        <- lisread("MAETXS.dat") 
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data2
rep2         <- reptoRlist("MAETXS.rep")
std2         <- read.table("MAETXS.std",header=T,sep="",na="NA",fill=T) 

# Zona XI
data3        <- lisread("MAETXI.dat") 
names(data3) <- str_trim(names(data3), side="right")
dat3         <- data3
rep3         <- reptoRlist("MAETXI.rep")
std3         <- read.table("MAETXI.std",header=T,sep="",na="NA",fill=T) 

```

```{r RetrospectivoXN, echo=F, warning=FALSE,eval=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAETXN",dir.0,dir.1,"/RetrospectivoXN") 
```


```{r RetrospectivoXS, echo=F, warning=FALSE,eval=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAETXS",dir.0,dir.1,"/RetrospectivoXS") 
```


```{r RetrospectivoXI, echo=F, warning=FALSE,eval=F}
source(paste(dir.fun,"Fn_Retrospectivo.R",sep=""))
Retrospectivo("MAETXI",dir.0,dir.1,"/RetrospectivoXI") 
```



```{r VerosimilitudXN, echo=F, warning=F,eval=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 3.17467674069
priorRo <- seq(1.9,4.1,0.1)
Verosimilitud("MAETXN",dir.0,dir.1,"/VerosimilitudXN",logRo,priorRo) 
```

```{r VerosimilitudXS, echo=F, warning=F,eval=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 4.57233200892
priorRo <- seq(3,6.5,0.1)
Verosimilitud("MAETXS",dir.0,dir.1,"/VerosimilitudXS",logRo,priorRo) 
```


```{r VerosimilitudXI, echo=F, warning=F,eval=F}
source(paste(dir.fun,"Fn_Verosimilitud.R",sep=""))
logRo    <- 4.80889832023
priorRo <- seq(3,6.5,0.1)
Verosimilitud("MAETXI",dir.0,dir.1,"/VerosimilitudXI",logRo,priorRo) 
```





# 1. RESUMEN EJECUTIVO

# 2. INTRODUCCI√ìN

# 3. ANTECEDENTES

## Contexto Normativo de los Planes de Manejo Bent√≥nico

## Plan de Manejo de erizo en las regiones de Los Lagos y Ays√©n

# 4. OBJETIVOS

## 4.1. Objetivo General

Evaluar el estado de situaci√≥n del/de los recurso/s objetivo y generar y analizar informaci√≥n que permita apoyar el establecimiento de medidas de administraci√≥n y la implementaci√≥n y evaluaci√≥n de Planes de Manejo de pesquer√≠as bent√≥nicas.

## 4.2. Objetivos espec√≠ficos

4.2.1.¬†¬†¬† Efectuar el an√°lisis de la situaci√≥n actualizada del recurso y su pesquer√≠a sobre la base de la informaci√≥n generada y disponible a la fecha, con la realizaci√≥n de evaluaciones de stock de los recursos, seg√∫n corresponda.

4.2.2.¬†¬†¬† Analizar informaci√≥n econ√≥mica y de mercado de recursos bent√≥nicos con planes de manejo en desarrollo.

4.2.3.¬†¬†¬† Evaluar el desempe√±o de los Planes de Manejo y proponer adaptaciones en funci√≥n de la informaci√≥n disponible.

4.2.4.¬†¬†¬† Brindar asesor√≠a t√©cnica en temas espec√≠ficos requeridos para la implementaci√≥n de planes de manejo de pesquer√≠as bent√≥nicas o medidas de administraci√≥n.

# 5. METODOLOG√çA

## 5.1. Objetivo espec√≠fico 4.2.1

*"Efectuar el an√°lisis de la situaci√≥n actualizada del recurso y su pesquer√≠a sobre la base de la informaci√≥n generada y disponible la fecha para la realizaci√≥n de evaluaciones de stock de los recursos".*

### 5.1.1. Para el recurso erizo (*Loxechinus albus*).

#### Unidades de stock


![Zonas de evaluaci√≥n estructuradas en base a los pol√≠gonos espaciales de la operaci√≥n de pesca de erizo X-XI regiones (Molinet *et al.*, 2011) que son consideradas como unidades de stock para este estudio.](Figuras/Area_estudio.png){width="12cm"}

#### Actualizaci√≥n de antecedentes y datos

1.  An√°lisis de los desembarques


(figura de Tallas)

![Zonas de evaluaci√≥n estructuradas en base a los pol√≠gonos espaciales de la operaci√≥n de pesca de erizo X-XI regiones (Molinet *et al.*, 2011) que son consideradas como unidades de stock para este estudio.](Figuras/Area_estudio.png){width="12cm"}


2.  Estructura de tallas de la pesquer√≠a




3.  √çndice de abundancia relativa (CPUE)

Para la obtenci√≥n de un √≠ndice de abundancia, se utilizaron modelos lineales generalizados (GLM; McCullagh & Nelder, 1989) donde el valor esperado de la captura (kg) por hora de buceo como Captura Por Unidad de Esfuerzo (CPUE) se supone explicada por un arreglo de factores siguiendo una combinaci√≥n lineal de la forma:

                  E(ùê∂ùëÉùëàùê∏ùë¶,ùë°,ùëß,ùëù)=ùëî‚àí1(ùëêùë°ùëí+ùê¥ùë¶+ùëáùë°+ ùëÉùëù+ùúéùë¶,ùë°,ùëù,ùëß)
                  
Donde g es la funci√≥n de enlace, A es el factor a√±o, T el factor trimestral, P la profundidad y œÉ es el t√©rmino de error aleatorio. El an√°lisis de devianza permiti√≥ evaluar la importancia de cada efecto en cada subregion de evaluaci√≥n, y en algunos casos como es la zona X norte, se analiz√≥ la interacci√≥n de primer orden A√±o*profundidad sobre la base de evidencias de mejoras en el rendimiento de pesca anual debido a cambios en la profundidad. El efecto anual en su escala exponencial exp(A) fue considerado como √≠ndice de abundancia para efectos de la evaluaci√≥n de stock. El tratamiento de los datos consider√≥ como rangos de profundidad los intervalos <15 m; 16-30 m; 31-45 m; y > 45 m) as√≠ como la exclusi√≥n de los registros superiores 450 kg/hora de buceo y aquellos por debajo 1 kg/hora, esto en base al conocimiento de terreno respecto del r√©gimen operacional del buceo extractivo.
Junto a ello, esta vez se utilizaron Modelos Lineales Generalizados Mixtos (GLMM), los cuales combinan las ideas de los modelos lineales generalizados con las ideas de modelado de efectos aleatorios. La respuesta es una variable aleatoria, Yi, que toma valores observados, yi, para i = 1, ..., n, y sigue una distribuci√≥n de familia exponencial con la forma:

```{r datInd2, warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="CPUE de entrada al modelo de evaluaci√≥n de stock para las tres unidades de stock de erizo"}


cpueXN_obs  <- data.frame(rep1$CPUE_obs)
cpueXS_obs  <- data.frame(rep2$CPUE_obs)
cpueXI_obs  <- data.frame(rep3$CPUE_obs)


 obscpueXN  <- as.data.frame(cpueXN_obs) %>% 
   mutate(year=yearc) %>% 
   melt(id.vars='year') %>% 
   mutate(type='CPUE_XNorte')
 obscpueXS  <- as.data.frame(cpueXS_obs) %>% 
   mutate(year=yearc) %>% 
   melt(id.vars='year') %>% 
   mutate(type='CPUE_XSur')
 obscpueXI  <- as.data.frame(cpueXI_obs) %>% 
   mutate(year=yearc) %>% 
   melt(id.vars='year') %>%
   mutate(type='CPUE_XI')
 

Ind2  <-rbind(obscpueXN,obscpueXS,obscpueXI)


p2 <- ggplot()  +
  geom_line(data=Ind2, aes(x=year, y =value), stat="identity", fill='gray66', 
                   color = 'gray28') + 
  facet_wrap(type~.,scale="free",dir = 'v', as.table = TRUE) + 
  labs(x="A√±os", y="Nominal CPUE (kg/hora*Buzo)")+
  theme(panel.background = element_rect(fill ="gray99")) + 
  theme(panel.grid=element_line(color="gray66"))+
  scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 1))+
  theme(axis.text.x = element_text(angle = 90, hjust = 2))+
  theme
  xlim(1996,2020)+
  ylim(50, 200)
p2

```




4.  Par√°metros de historia de vida

-   Crecimiento

-   Mortalidad natural

-   Madurez sexual

#### Evaluaci√≥n de stock

1.  Mortalidad por pesca

2.  Selectividad

3.  Capturabilidad

4.  Ponderadores de la informaci√≥n

-   Tama√±o de muestra

-   Coeficientes de variaci√≥n

#### Estimaci√≥n de Puntos Biol√≥gicos de Referencia (PBR)

#### Diagn√≥stico del modelo

1.  An√°lisis de ajustes y residuales

2.  An√°lisis retrospectivo

3.  Perfil de verosimilitud

4.  An√°lisis de sensibilidad

# 6. RESULTADOS

## 6.1. Objetivo espec√≠fico 4.2.1

*"Efectuar el an√°lisis de la situaci√≥n actualizada del recurso y su pesquer√≠a sobre la base de la informaci√≥n generada y disponible la fecha para la realizaci√≥n de evaluaciones de stock de los recursos".*

### 6.1.1. Erizo zona norte Regi√≥n de Los Lagos

#### Diagn√≥stico del modelo

1.  Ajustes del modelo a los datos observados

```{r Dat_Ajustes_indices, echo=FALSE, message=FALSE, warning=FALSE, include=T}

yrs   <- rep1$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvcpue   <-0.20
cvdes   <-0.05

# Erizo X Norte
ind_obsXN               <- cbind(rep1$CPUE_obs, rep1$Desemb_obs); 
ind_obsXN[ind_obsXN==0] <- NA
colnames(ind_obsXN)     <- c('CPUE', 'Desembarques') 
indXN                   <- data.frame(ind_obsXN) %>% mutate(Asesoria='observado') %>% mutate (yrs= yrs) %>% melt(id.var=c('yrs', 'Asesoria'))  

ind_predXN           <- cbind(c(rep1$CPUE_pred), c(rep1$Desemb_pred)) 
colnames(ind_predXN) <- c('CPUE', 'Desembarques') 
predXN               <- data.frame(ind_predXN) %>% mutate (Asesoria='√çndices') %>% mutate (yrs= yrs)  %>% melt(id.var=c('yrs', 'Asesoria'))

baseXN <- data.frame(rbind(indXN, predXN))  

# Erizo X Sur
ind_obsXS           <- cbind(rep2$CPUE_obs, rep2$Desemb_obs); ind_obsXS[ind_obsXS==0] <- NA
colnames(ind_obsXS) <- c('CPUE', 'Desembarques') 
indXS               <- data.frame(ind_obsXS) %>% mutate(Asesoria='observado') %>% mutate (yrs= yrs) %>% melt(id.var=c('yrs', 'Asesoria'))  

ind_predXS           <- cbind(c(rep2$CPUE_pred), c(rep2$Desemb_pred)) 
colnames(ind_predXS) <- c('CPUE', 'Desembarques') 
predXS               <- data.frame(ind_predXS) %>% mutate (Asesoria='√çndices') %>% mutate (yrs= yrs)  %>% melt(id.var=c('yrs', 'Asesoria'))

baseXS <- data.frame(rbind(indXS, predXS))  

# Erizo XI
ind_obsXI           <- cbind(rep3$CPUE_obs, rep3$Desemb_obs); ind_obsXI[ind_obsXI==0] <- NA
colnames(ind_obsXI) <- c('CPUE', 'Desembarques') 
indXI               <- data.frame(ind_obsXI) %>% mutate(Asesoria='observado') %>% mutate (yrs= yrs) %>% melt(id.var=c('yrs', 'Asesoria'))  

ind_predXI           <- cbind(c(rep3$CPUE_pred), c(rep3$Desemb_pred)) 
colnames(ind_predXI) <- c('CPUE', 'Desembarques') 
predXI               <- data.frame(ind_predXI) %>% mutate (Asesoria='√çndices') %>% mutate (yrs= yrs)  %>% melt(id.var=c('yrs', 'Asesoria'))

baseXI <- data.frame(rbind(indXI, predXI))  

```

```{r  Fig_ajustesIndices_XN, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center", fig.height=6, fig.path=dir.Fig, fig.width=6, dev=fig, include=T, fig.cap="**Figura 1**. Ajuste del modelo a la informaci√≥n de CPUE, desembarque para el erizo de la zona X Norte. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La l√≠nea negra s√≥lida muestra el valor estimado por el modelo"}

cpueXN <- ggplot(baseXN %>% filter(Asesoria!='observado', variable=='CPUE'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXN %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXN %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Kg/hora') +
       theme_bw(base_size=9) + 
       ggtitle('CPUE zona X Norte')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXN <- ggplot(baseXN %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXN %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXN %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=12) + 
       ggtitle('Desembarques zona X Norte')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXN/desXN + plot_layout(guides="collect")

```

```{r Fig_ajustesCompFXN,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Ajustes de la proporci√≥n de tallas de erizo de la zona XN"}
age  <-rep1$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep1$pobs)
etcf1_pre <- rbind(rep1$ppred) 

yearc1   <- rep1$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) +
          labs(x = 'Longitud', y = 'Proporci√≥n') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA Zona XNorte") + theme(plot.title = element_text(size = 12))
  fig1

```

1.  ***An√°lisis de residuos***

```{r Fig_residualesIndicesXN,warning=F, include=T, message=F, echo=FALSE,fig.height=7,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Residuos de la CPUE y desembarques de erizo de la zona X Norte"}

predcpue        <- rep1$CPUE_pred
obscpue         <- rep1$CPUE_obs       ;obscpue[obscpue<=1] <-NA  
Res_cpue   <- log(obscpue)-log(predcpue) 

obsD         <- rep1$Desemb_obs
predD        <- rep1$Desemb_pred
Res_Desemb   <- log(obsD)-log(predD)

par(mfcol=c(3,2),mar=c(4,4,1,1)+0.5)
	plot(yrs,Res_cpue,cex.axis=0.8,type="h",main="CPUE zona X norte",ylab="Residuales (escala log)",xlab="")
	abline(h=0,col="darkgray")
	plot(log(predcpue),Res_cpue, main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
	abline(h=0,col="darkgray")
	qqnorm(Res_cpue); qqline(Res_cpue, col = 2)
	
	
plot(yrs,Res_Desemb,cex.axis=0.8,ylim=c(-0.01,0.01),type="h",main="Desembarques zona X norte",ylab="Residuales (escala log)",xlab="")
abline(h=0,col="darkgray")
plot(log(predD),Res_Desemb, ylim=c(-0.01,0.01),main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
abline(h=0,col="darkgray")
qqnorm(Res_Desemb,ylim=c(-0.01,0.01)); qqline(Res_Desemb, col = 2)

```    

```{r Fig_residuosCompXN,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Residuos de la proporci√≥n de tallas de erizo de la zona X Norte"}

ppredF <-rep1$ppred[37:61,]
anos   <-yrs[37:61]
obsF   <-rep1$pobs[37:61,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona X norte",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("A√±os",side=2,line=4.7,cex=1.1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

```



2.  ***An√°lisis retrospectivo***



```{r VariablesXN_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep1$years
nyears<-length(years)

Rt1      <- subset(std1,name=="Rest")$value 
Rt1std   <- subset(std1,name=="Rest")$std
BT1      <- subset(std1,name=="BT")$value   
BT1std   <- subset(std1,name=="BT")$std
BD1      <- subset(std1,name=="BD")$value   
BD1std   <- subset(std1,name=="BD")$std
Ft1      <- subset(std1,name=="log_F")$value   
Ft1std   <- subset(std1,name=="log_F")$std

VarPob<- data.frame(x=years, Rt1=Rt1,BT1=BT1,BD1=BD1,Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std), upperRt1 = (Rt1+1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std), upperBT1 = (BT1+1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), upperBD1 = (BD1+1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), upperFt1 = exp(Ft1+1.96*Ft1std))

```

```{r Dat_RetrospectivoXN, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RetrospectivoXN",sep="")
setwd(dir)
admb<-"MAETXN"

years<-rep1$years
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$R_Est,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }


# retrospectivo relativo (c√°lculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, y1=retroR[,2],y2=retroR[,3],y3=retroR[,4],y4=retroR[,5],y5=retroR[,6],
                      lower = (Rt1 -1.96*Rt1std), upper = (Rt1+1.96*Rt1std))
BD_retro<- data.frame(x=years, y1=retroBD[,2],y2=retroBD[,3],y3=retroBD[,4],y4=retroBD[,5],y5=retroBD[,6],
                      lower = (BD1 -1.96*BD1std), upper = (BD1+1.96*BD1std))
Ft_retro<- data.frame(x=years, y1=retroF[,2],y2=retroF[,3],y3=retroF[,4],y4=retroF[,5],y5=retroF[,6], 
                      lower = exp(Ft1-1.96*Ft1std), upper = exp(Ft1+1.96*Ft1std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, y1=rel.diff.r[,1],y2=rel.diff.r[,2],y3=rel.diff.r[,3],y4=rel.diff.r[,4],y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, y1=rel.diff.ssb[,1],y2=rel.diff.ssb[,2],y3=rel.diff.ssb[,3],y4=rel.diff.ssb[,4],y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, y1=rel.diff.f[,1],y2=rel.diff.f[,2],y3=rel.diff.f[,3],y4=rel.diff.f[,4],y5=rel.diff.f[,5])

```

```{r Fig_RetrospectivoXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**.	Patr√≥n retrospectivo est√°ndar (panel izquierdo) y  relativo (panel derecho) de los reclutamientos", fig.height=10, fig.width=10}

#Retrospectivo tradicional
Rt <- ggplot(Rt_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Reclutamientos',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

3.  ***Perfil de verosimilitud***


```{r Fig_VerosimilitudXN,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**.	Perfil de verosimilitud erizo zona X norte", fig.height=10, fig.width=10}

source(paste(dir.fun,"functions.R",sep=""))
dir       <-paste(dir.0,"/VerosimilitudXN",sep="")
setwd(dir)

casos <-23
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=5,nrow=casos)
slikeval <- matrix(ncol=6,nrow=casos)


for(i in 1:casos){
report      <- reptoRlist(paste(dir,"//MAETXNs",i,".rep",sep=""))
logRo[i]    <- report$Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)                         # busca el m√≠nimo
for(i in 1:6){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarizaci√≥n

names<-c("Ro","cpue","desembarque","propF","devRo","log_F","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2 <- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names

par(mar=c(4,4,1,1))
plot(TLk2$Ro,TLk2$Total,type="l",lwd=3,ylim=c(0,3),xlim=c(0.5,45),xaxs="i",ylab="L-min(L)",xlab="Ro",las=1,main='Erizo zona X norte',cex.axis=0.7,cex.main=0.8,cex.lab=0.8)

lines(c(0,TLk2$Ro),rep(2,casos+1),lty=2,lwd=2)
for(i in 2:6){lines(TLk2$Ro,TLk2[,i],col=i,lty=2,lwd=2)}
legend(30,3,names[c(7,2:6)],col=1:7,lty=c(1,rep(2,6)),lwd=2,bty="n",cex=0.7)


```



#### Variables de estado

```{r Fig_VarpoblXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Variables poblacionales de Erizo zona X Norte", fig.height=6, fig.width=8}


Rt <- ggplot(VarPob) + 
    geom_line(aes(y=Rt1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
    geom_ribbon(aes(ymin=lowerRt1, ymax=upperRt1, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BT <- ggplot(VarPob) + 
     geom_line(aes(y=BT1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBT1, ymax=upperBT1, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa total',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt1, ymax=upperFt1, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT | (BD/Ft)


```

```{r Fig_SelFlotaXN,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Selectividad de la flota de la Zona X Norte"}
# ASESORIA DE SEPTIEMBRE
age<-rep1$Edades
par(mfrow=c(1,1),mar=c(4,4,1,1))
	plot(age,rep1$Sel_f[1,],type="l",lwd=2,las=1,ylim=c(0,1.1),ylab="Selectividad",xlab="Edad (a√±o)")
	lines(age,rep1$Sel_f[44,],type="o",pch="o")
	legend (6,0.5,c("sel_bloque (1960-2002)","sel_bloque (2003-2020)"),pch=c("","o"),lwd=c(2,1),bty='n',cex=0.8)

```


#### Puntos Biol√≥gicos de Referencia

```{r Fig_PBRsXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Puntos Biol√≥gicos de referencia de Erizo zona X Norte", fig.height=7, fig.width=6}

Frms<-dat1$FMRS
BDo<-rep1$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD1, ymax=upperBD1, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
     geom_hline(yintercept = c(BDrms,BDlim,BDo),colour=c('green3','red','blue'))+
  annotate("text", x=c(rep(2012,3)), y=c(BDrms,BDlim,BDo),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]))) +
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft1, x=x, colour = "Estimado Zona X Norte"), size=0.5)+
   geom_hline(yintercept = c(Frms),colour=c('green3')) +
     annotate("text", x=c(2011), y=c(Frms),label=c(expression("F"[RMS]))) +
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black")) +
    scale_fill_manual("",values=c("grey30")) +
    theme_bw(base_size=8) +
     ggtitle('') +
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

 BD/Ft


```


#### Indicadores del estatus



#### Estatus del erizo de la zona norte de la Regi√≥n de Los Lagos

```{r Fig_DiagramaFaseXN, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Diagrama de fase Erizo zona X Norte", fig.height=8, fig.width=10}
Zona<- "Erizo Zona X Norte"
Frms<-dat1$FMRS
BDo<-rep1$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2


bd_bdrms<-(VarPob$BD1/BDrms) 
f_frms<-(VarPob$Ft1/Frms)

Qmult<- -qnorm((1-(80/100))/2.0)

sb95min <-BD1[nyears]-Qmult*BD1std[nyears]/BDrms
sb95max <-BD1[nyears]+Qmult*BD1std[nyears]/BDrms
F95min  <- exp(Ft1[nyears])*exp(-Qmult*Ft1std[nyears])/Frms
F95max  <-exp(Ft1[nyears])*exp(Qmult*Ft1std[nyears])/Frms

x.bottom.left <- c(1, 0, 1, 1)
x.top.left    <- c(1, 0, 1, 1)
x.bottom.right<- c(0, 1, 3, 3)
x.top.right   <- c(0, 1, 3, 3)

y.bottom.left <- c(0, 1, 0, 1)
y.bottom.right<- c(0, 1, 0, 1)
y.top.left    <- c( 1, 10,  1, 10)
y.top.right   <- c( 1, 10,  1, 10)

# declare a vector of values
values <- c("1_Sobreexplotaci√≥n","2_Sobreexplotaci√≥n","3_Subexplotaci√≥n","4_Sobrepesca")
# create a data frame containing values and ids
values.df <- data.frame(value = values, id = c(1, 2, 3, 4))
# create the x and y vectors containing the coordinates of each polygon in the correct order
x.coords <- unlist(lapply(1:length(x.bottom.left), function(i) {
    c(x.bottom.left[i], x.bottom.right[i], x.top.right[i], x.top.left[i])
}))
y.coords <- unlist(lapply(1:length(y.bottom.left), function(i) {
    c(y.bottom.left[i], y.bottom.right[i], y.top.right[i], y.top.left[i])
}))
# create a coordinates data frame
coords.df <- data.frame(id = rep(c(1, 2, 3, 4), each = 4), x = x.coords, y = y.coords)
# merge the data frames
data.df <- merge(values.df, coords.df, by = c("id"))

# plot
ggplot() + 
  geom_polygon(data = data.df, aes(x = x, y = y, fill = factor(value), group = id,alpha = 0.9)) +
scale_fill_grey(start=0.4, end=0.9) +
geom_hline(yintercept = 1) + geom_vline(xintercept = c(0.5,1),colour=c(2,1)) +
annotate("text", x=c(0.5,1,3.07), y=c(10.07,10.07,1.07),
              label=c(expression("BD"[LIM]),expression("BD"[RMS]),expression("F"[RMS]))) +
  geom_path(aes(x=bd_bdrms,y=f_frms)) +
  geom_point(aes(x=bd_bdrms,y=f_frms),shape = 21, colour = "black", fill = "white", size = 2.5, stroke = 1)+
  geom_point(aes(x=bd_bdrms[c(nyears,1)],y=f_frms[c(nyears,1)]),shape =c(21,21), colour = c("blue","green"), fill =c("blue4","green4"), size =c(4,4), stroke =c(1,1)) +
   geom_text(aes(x=bd_bdrms,y=f_frms,label=years),angle = 45,nudge_y = 0.15,size = 3) +
labs(x = expression("BD/BD"[RMS]), y = expression("F/F"[RMS]),fill='Estados de explotaci√≥n') +
   theme_bw(base_size=15) +
  ggtitle(Zona)

```



### 6.1.2. Erizo zona sur Regi√≥n de Los Lagos

#### Diagn√≥stico del modelo

1.  Ajustes del modelo a los datos observados

```{r Fig_ajustesIndices_XS, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center",fig.path=dir.Fig, fig.height=6,  fig.width=6, dev=fig, include=T, fig.cap="**Figura 1**. Ajuste del modelo a la informaci√≥n de CPUE, desembarque para el erizo de la zona X Sur. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La l√≠nea negra s√≥lida muestra el valor estimado por el modelo"}

cpueXS <- ggplot(baseXS %>% filter(Asesoria!='observado', variable=='CPUE'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXS %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXS %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = ' Kg/hora') +
       theme_bw(base_size=9) + 
       ggtitle('CPUE zona X Sur')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXS <- ggplot(baseXS %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXS %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXS %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques zona X Sur')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXS/desXS + plot_layout(guides="collect")

```

```{r ajustesCompFXS,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig,  fig.cap="**Figura x**. Ajustes de la proporci√≥n de tallas de erizo de la zona X Sur"}
age  <-rep2$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep2$pobs)
etcf1_pre <- rbind(rep2$ppred) 

yearc1   <- rep2$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporci√≥n') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA Zona X Sur") + theme(plot.title = element_text(size = 12))
  fig1

```

1.  An√°lisis de residuos de erizo zona X sur

```{r Fig_residualesIndicesXS,warning=F, include=T, message=F, echo=FALSE,fig.height=7,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Residuos de la CPUE y desembarques de erizo de la zona X Sur"}

predcpue        <- rep2$CPUE_pred
obscpue         <- rep2$CPUE_obs       ;obscpue[obscpue<=1] <-NA  
Res_cpue   <- log(obscpue)-log(predcpue) 

obsD         <- rep2$Desemb_obs
predD        <- rep2$Desemb_pred
Res_Desemb   <- log(obsD)-log(predD)

par(mfcol=c(3,2),mar=c(4,4,1,1)+0.5)
	plot(yrs,Res_cpue,cex.axis=0.8,type="h",main="CPUE zona X sur",ylab="Residuales (escala log)",xlab="")
	abline(h=0,col="darkgray")
	plot(log(predcpue),Res_cpue, main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
	abline(h=0,col="darkgray")
	qqnorm(Res_cpue); qqline(Res_cpue, col = 2)
	
	
plot(yrs,Res_Desemb,cex.axis=0.8,ylim=c(-0.01,0.01),type="h",main="Desembarques zona X sur",ylab="Residuales (escala log)",xlab="")
abline(h=0,col="darkgray")
plot(log(predD),Res_Desemb, ylim=c(-0.01,0.01),main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
abline(h=0,col="darkgray")
qqnorm(Res_Desemb,ylim=c(-0.01,0.01)); qqline(Res_Desemb, col = 2)

```    

```{r Fig_residuosCompXS,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Residuos de la proporci√≥n de tallas de erizo de la zona X sur"}

ppredF <-rep2$ppred[28:60,]
anos   <-yrs[28:60]
obsF   <-rep2$pobs[28:60,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona X sur",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("A√±os",side=2,line=4.7,cex=1.1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

```


2.  An√°lisis retrospectivo de erizo zona X sur

```{r VariablesXS_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep2$years
nyears<-length(years)

Rt2      <- subset(std2,name=="Rest")$value 
Rt2std   <- subset(std2,name=="Rest")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="BD")$value   
BD2std   <- subset(std2,name=="BD")$std
Ft2      <- subset(std2,name=="log_F")$value   
Ft2std   <- subset(std2,name=="log_F")$std

VarPob<- data.frame(x=years, Rt2=Rt2,BT2=BT2,BD2=BD2,Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std), upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), upperFt2 = exp(Ft2+1.96*Ft2std))

```

```{r Dat_RetrospectivoXS, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RetrospectivoXS",sep="")
setwd(dir)
admb<-"MAETXS"

years<-rep2$years
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$R_Est,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }



# retrospectivo relativo (c√°lculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, y1=retroR[,2],y2=retroR[,3],y3=retroR[,4],y4=retroR[,5],y5=retroR[,6],
                      lower = (Rt2 -1.96*Rt2std), upper = (Rt2+1.96*Rt2std))
BD_retro<- data.frame(x=years, y1=retroBD[,2],y2=retroBD[,3],y3=retroBD[,4],y4=retroBD[,5],y5=retroBD[,6],
                      lower = (BD2 -1.96*BD2std), upper = (BD2+1.96*BD2std))
Ft_retro<- data.frame(x=years, y1=retroF[,2],y2=retroF[,3],y3=retroF[,4],y4=retroF[,5],y5=retroF[,6], 
                      lower = exp(Ft2-1.96*Ft2std), upper = exp(Ft2+1.96*Ft2std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, y1=rel.diff.r[,1],y2=rel.diff.r[,2],y3=rel.diff.r[,3],y4=rel.diff.r[,4],y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, y1=rel.diff.ssb[,1],y2=rel.diff.ssb[,2],y3=rel.diff.ssb[,3],y4=rel.diff.ssb[,4],y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, y1=rel.diff.f[,1],y2=rel.diff.f[,2],y3=rel.diff.f[,3],y4=rel.diff.f[,4],y5=rel.diff.f[,5])



```

```{r Fig_RetrospectivoXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**.	Patr√≥n retrospectivo est√°ndar (panel izquierdo) y  relativo (panel derecho) de los reclutamientos", fig.path=dir.Fig,fig.height=7, fig.width=6}

Rt <- ggplot(Rt_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

3.  Perfil de verosimilitud de erizo zona X sur

```{r Fig_VerosimilitudXS,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**.	Perfil de verosimilitud erizo zona X sur", fig.height=10, fig.width=10}

source(paste(dir.fun,"functions.R",sep=""))
dir       <-paste(dir.0,"/VerosimilitudXS",sep="")
setwd(dir)

casos <-36
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=5,nrow=casos)
slikeval <- matrix(ncol=6,nrow=casos)

for(i in 1:casos){
report      <- reptoRlist(paste(dir,"//MAETXSs",i,".rep",sep=""))
logRo[i]    <- report$Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)                         # busca el m√≠nimo
for(i in 1:6){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarizaci√≥n

names<-c("Ro","cpue","desembarque","propF","devRo","log_F","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2 <- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names

par(mar=c(4,4,1,1))
plot(TLk2$Ro,TLk2$Total,type="l",lwd=3,ylim=c(0,3),xlim=c(0.5,200),xaxs="i",ylab="L-min(L)",xlab="Ro",las=1,main='Erizo zona X sur',cex.axis=0.7,cex.main=0.8,cex.lab=0.8)

lines(c(0,TLk2$Ro),rep(2,casos+1),lty=2,lwd=2)
for(i in 2:6){lines(TLk2$Ro,TLk2[,i],col=i,lty=2,lwd=2)}
legend(30,3,names[c(7,2:6)],col=1:7,lty=c(1,rep(2,6)),lwd=2,bty="n",cex=0.7)


```

#### Variables de estado de erizo Zona X sur.

```{r Fig_VarpoblXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Variables poblacionales de Erizo zona X Sur", fig.path=dir.Fig,fig.height=6, fig.width=8}


Rt <- ggplot(VarPob) + 
    geom_line(aes(y=Rt2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
    geom_ribbon(aes(ymin=lowerRt2, ymax=upperRt2, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BT <- ggplot(VarPob) + 
     geom_line(aes(y=BT2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa total',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT | BD/Ft


```

```{r Fig_SelFlotaXS,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Selectividad de la flota de la Zona X sur"}
# ASESORIA DE SEPTIEMBRE
age<-rep2$Edades
par(mfrow=c(1,1),mar=c(4,4,1,1))
	plot(age,rep2$Sel_f[1,],type="l",lwd=2,las=1,ylim=c(0,1.1),ylab="Selectividad",xlab="Edad (a√±o)")
	legend (6,0.5,c("sel_bloque (1960-2020)"),pch=c(""),lwd=c(2),bty='n',cex=0.8)

```


#### Puntos Biol√≥gicos de Referencia

```{r Fig_PBRsXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Puntos Biol√≥gicos de referencia de Erizo zona X Sur", fig.height=7, fig.width=6}

Frms<-dat2$FMRS
BDo<-rep2$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
   geom_hline(yintercept = c(BDrms,BDlim,BDo),colour=c('green3','red','blue'))+
  annotate("text", x=c(rep(2012,3)), y=c(BDrms,BDlim,BDo),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]))) +
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft2, x=x, colour = "Estimado Zona X sur"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = ""), alpha = 0.2)+
  geom_hline(yintercept = c(Frms),colour=c('green3')) +
     annotate("text", x=c(2011), y=c(Frms),label=c(expression("F"[RMS]))) +
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


 BD/Ft


```


#### Indicadores del estatus

#### Estatus del erizo de la zona sur de la Regi√≥n de Los Lagos

```{r Fig_DiagramaFaseXS, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Diagrama de fase Erizo zona X Sur", fig.height=8, fig.width=10}
Zona<- "Erizo Zona X Sur"
Frms<-dat2$FMRS
BDo<-rep2$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2

bd_bdrms<-VarPob$BD2/BDrms
f_frms<-VarPob$Ft2/Frms

x.bottom.left <- c(1, 0, 1, 1)
x.top.left    <- c(1, 0, 1, 1)
x.bottom.right<- c(0, 1, 3, 3)
x.top.right   <- c(0, 1, 3, 3)

y.bottom.left <- c(0, 1, 0, 1)
y.bottom.right<- c(0, 1, 0, 1)
y.top.left    <- c( 1, 10,  1, 10)
y.top.right   <- c( 1, 10,  1, 10)

# declare a vector of values
values <- c("1_Sobreexplotaci√≥n","2_Sobreexplotaci√≥n","3_Subexplotaci√≥n","4_Sobrepesca")
# create a data frame containing values and ids
values.df <- data.frame(value = values, id = c(1, 2, 3, 4))
# create the x and y vectors containing the coordinates of each polygon in the correct order
x.coords <- unlist(lapply(1:length(x.bottom.left), function(i) {
    c(x.bottom.left[i], x.bottom.right[i], x.top.right[i], x.top.left[i])
}))
y.coords <- unlist(lapply(1:length(y.bottom.left), function(i) {
    c(y.bottom.left[i], y.bottom.right[i], y.top.right[i], y.top.left[i])
}))
# create a coordinates data frame
coords.df <- data.frame(id = rep(c(1, 2, 3, 4), each = 4), x = x.coords, y = y.coords)
# merge the data frames
data.df <- merge(values.df, coords.df, by = c("id"))



# plot
ggplot() + 
  geom_polygon(data = data.df, aes(x = x, y = y, fill = factor(value), group = id,alpha = 0.9)) +
scale_fill_grey(start=0.4, end=0.9) +
geom_hline(yintercept = 1) + geom_vline(xintercept = c(0.5,1),colour=c(2,1)) +
annotate("text", x=c(0.5,1,3.07), y=c(10.07,10.07,1.07),
              label=c(expression("BD"[LIM]),expression("BD"[RMS]),expression("F"[RMS]))) +
  geom_path(aes(x=bd_bdrms,y=f_frms)) +
  geom_point(aes(x=bd_bdrms,y=f_frms),shape = 21, colour = "black", fill = "white", size = 2.5, stroke = 1)+
  geom_point(aes(x=bd_bdrms[c(nyears,1)],y=f_frms[c(nyears,1)]),shape =c(21,21), colour = c("blue","green"), fill =c("blue4","green4"), size =c(4,4), stroke =c(1,1)) +
   geom_text(aes(x=bd_bdrms,y=f_frms,label=years),angle = 45,nudge_y = 0.15,size = 3) +
labs(x = expression("BD/BD"[RMS]), y = expression("F/F"[RMS]),fill='Estados de explotaci√≥n') +
   theme_bw(base_size=15) +
  ggtitle(Zona)

```

### 6.1.3. Erizo Regi√≥n de Ays√©n

#### Diagn√≥stico del modelo

1.  Ajustes del modelo a los datos observados

```{r Fig_ajustesIndices_XI, echo=FALSE,message=FALSE, warning=FALSE, fig.align="center", fig.height=6, fig.path=dir.Fig, fig.width=6, dev=fig, include=T, fig.cap="**Figura 1**. Ajuste del modelo a la informaci√≥n de CPUE, desembarque para el erizo de la zona X Sur. Los puntos representan a las observaciones junto a sus niveles de incertidumbre. La l√≠nea negra s√≥lida muestra el valor estimado por el modelo"}

cpueXI <- ggplot(baseXI %>% filter(Asesoria!='observado', variable=='CPUE'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXI %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXI %>% filter(Asesoria=='observado', variable=='CPUE'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Kg/hora') +
       theme_bw(base_size=9) + 
       ggtitle('CPUE zona XI')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

desXI <- ggplot(baseXI %>% filter(Asesoria!='observado', variable=='Desembarques'), 
       aes(yrs,value)) + 
       geom_line(aes(colour=Asesoria), size=0.8) +
       scale_colour_manual(values=c('black')) +
       geom_point(data = baseXI %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(yrs,value), shape = 19, colour = 'gray30') +
       geom_errorbar(data = baseXI %>% filter(Asesoria=='observado', variable=='Desembarques'),
       aes(ymin = value*exp(-1.96*cvcpue), ymax = value*exp(1.96*cvcpue)), color = 'gray30') +
       scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 5)) +
       labs(x = '', y = 'Toneladas') +
       theme_bw(base_size=9) + 
       ggtitle('Desembarques zona XI')+
       theme(plot.title = element_text(hjust = 0.5),legend.position="none")

cpueXI/desXI + plot_layout(guides="collect")


```


```{r ajustesCompFXI,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=8,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**.Ajustes de la proporci√≥n de tallas de erizo de la zona XI"}
age  <-rep3$Tallas                                          
nage<-length(age)   

etcf1_obs <- data.frame(rep3$pobs)
etcf1_pre <- rbind(rep3$ppred) 

yearc1   <- rep3$years
nyearc1  <- length(yearc1)  

 obs  <- as.data.frame(etcf1_obs) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='obs')
 
 pred_sep <- as.data.frame(etcf1_pre) %>% mutate(year=yearc1) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc1)) %>% mutate(type='')
 
  mat  <- rbind(obs,pred_sep)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray78') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Edad', y = 'Proporci√≥n') +
          geom_line(data = mat %>% filter(type != 'obs'), aes(x = edad, y = value, colour=type)) +
          scale_colour_manual(values=c('red'),name="") +
          theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA)) +
          ggtitle("FLOTA zona XI") + theme(plot.title = element_text(size = 12))
  fig1

```



1.  An√°lisis de residuos

```{r Fig_residualesIndicesXI,warning=F, include=T, message=F, echo=FALSE,fig.height=7,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Residuos de la CPUE y desembarques de erizo de la zona XI"}

predcpue        <- rep3$CPUE_pred
obscpue         <- rep3$CPUE_obs       ;obscpue[obscpue<=1] <-NA  
Res_cpue   <- log(obscpue)-log(predcpue) 

obsD         <- rep3$Desemb_obs
predD        <- rep3$Desemb_pred
Res_Desemb   <- log(obsD)-log(predD)

par(mfcol=c(3,2),mar=c(4,4,1,1)+0.5)
	plot(yrs,Res_cpue,cex.axis=0.8,type="h",main="CPUE zona XI",ylab="Residuales (escala log)",xlab="")
	abline(h=0,col="darkgray")
	plot(log(predcpue),Res_cpue, main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
	abline(h=0,col="darkgray")
	qqnorm(Res_cpue); qqline(Res_cpue, col = 2)
	
	
plot(yrs,Res_Desemb,cex.axis=0.8,ylim=c(-0.01,0.01),type="h",main="Desembarques zona XI",ylab="Residuales (escala log)",xlab="")
abline(h=0,col="darkgray")
plot(log(predD),Res_Desemb, ylim=c(-0.01,0.01),main="Residuales vs ajustado",ylab="Residuales",xlab="Valor ajustado")
abline(h=0,col="darkgray")
qqnorm(Res_Desemb,ylim=c(-0.01,0.01)); qqline(Res_Desemb, col = 2)

```    

```{r Fig_residuosCompXI,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=6,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Residuos de la proporci√≥n de tallas de erizo de la zona XI"}

ppredF <-rep3$ppred[29:60,]
anos   <-yrs[29:60]
obsF   <-rep3$pobs[29:60,]
preF   <-ppredF

resF <-obsF-preF
rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mfrow=c(1,1),mar=c(5.4,6.7,2,1),cex.axis=1,cex.lab=1.1)
fig1<-image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2.82*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2.82*sqrt(vol*-1),col=1)}
}}}

mtext("Residuos Flota zona XI",side=3,cex=1.2)
mtext("Edades",side=1,line=3.2,cex=1.1);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2)
mtext("A√±os",side=2,line=4.7,cex=1.1)
mtext("a)",side=3,line=0.25,adj=-0.15,cex=1.5)
box()

```


2.  An√°lisis retrospectivo

```{r VariablesXI_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep3$years
nyears<-length(years)

Rt3      <- subset(std3,name=="Rest")$value 
Rt3std   <- subset(std3,name=="Rest")$std
BT3      <- subset(std3,name=="BT")$value   
BT3std   <- subset(std3,name=="BT")$std
BD3      <- subset(std3,name=="BD")$value   
BD3std   <- subset(std3,name=="BD")$std
Ft3      <- subset(std3,name=="log_F")$value   
Ft3std   <- subset(std3,name=="log_F")$std

VarPob<- data.frame(x=years, Rt3=Rt3,BT3=BT3,BD3=BD3,Ft3=exp(Ft3), 
         lowerRt3 = (Rt3 -1.96*Rt3std), upperRt3 = (Rt3+1.96*Rt3std),
         lowerBT3 = (BT3 -1.96*BT3std), upperBT3 = (BT3+1.96*BT3std),
         lowerBD3 = (BD3 -1.96*BD3std), upperBD3 = (BD3+1.96*BD3std),
         lowerFt3 = exp(Ft3 -1.96*Ft3std), upperFt3 = exp(Ft3+1.96*Ft3std))

```

```{r Dat_RetrospectivoXI, echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/RetrospectivoXI",sep="")
setwd(dir)
admb<-"MAETXI"

years<-rep3$years
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$R_Est,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }


# retrospectivo relativo (c√°lculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, y1=retroR[,2],y2=retroR[,3],y3=retroR[,4],y4=retroR[,5],y5=retroR[,6],
                      lower = (Rt3 -1.96*Rt3std), upper = (Rt3+1.96*Rt3std))
BD_retro<- data.frame(x=years, y1=retroBD[,2],y2=retroBD[,3],y3=retroBD[,4],y4=retroBD[,5],y5=retroBD[,6],
                      lower = (BD3 -1.96*BD3std), upper = (BD3+1.96*BD3std))
Ft_retro<- data.frame(x=years, y1=retroF[,2],y2=retroF[,3],y3=retroF[,4],y4=retroF[,5],y5=retroF[,6], 
                      lower = exp(Ft3-1.96*Ft3std), upper = exp(Ft3+1.96*Ft3std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, y1=rel.diff.r[,1],y2=rel.diff.r[,2],y3=rel.diff.r[,3],y4=rel.diff.r[,4],y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, y1=rel.diff.ssb[,1],y2=rel.diff.ssb[,2],y3=rel.diff.ssb[,3],y4=rel.diff.ssb[,4],y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, y1=rel.diff.f[,1],y2=rel.diff.f[,2],y3=rel.diff.f[,3],y4=rel.diff.f[,4],y5=rel.diff.f[,5])

```

```{r Fig_RetrospectivoXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**.	Patr√≥n retrospectivo est√°ndar (panel izquierdo) y  relativo (panel derecho) de los reclutamientos", fig.path=dir.Fig,fig.height=7, fig.width=6}

Rt <- ggplot(Rt_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    annotate("text", x=1975, y=0.5,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del √∫ltimo a√±o',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = 1960, to = 2020, by = 10)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

3.  Perfil de verosimilitud

```{r Fig_VerosimilitudXI,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**.	Perfil de verosimilitud erizo zona XI", fig.height=10, fig.width=10}

source(paste(dir.fun,"functions.R",sep=""))

dir       <-paste(dir.0,"/VerosimilitudXI",sep="")
setwd(dir)

casos <-34
logRo    <- rep(0,casos)
likeval  <- matrix(ncol=5,nrow=casos)
slikeval <- matrix(ncol=6,nrow=casos)

for(i in 1:casos){
report      <- reptoRlist(paste(dir,"//MAETXIs",i,".rep",sep=""))
logRo[i]    <- report$Ro
likeval[i,] <- report$likeval}

like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
minLik  <- apply(like,2,min)                         # busca el m√≠nimo
for(i in 1:6){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarizaci√≥n

names<-c("Ro","cpue","desembarque","propF","devRo","log_F","Total")
# Tabla verosimilitud
TLk1 <- data.frame(exp(logRo),like);colnames(TLk1)<-names
# Tabla estandarizada
TLk2 <- data.frame(exp(logRo),slikeval);colnames(TLk2)<-names

par(mar=c(4,4,1,1))
plot(TLk2$Ro,TLk2$Total,type="l",lwd=3,ylim=c(0,3),xlim=c(0.5,200),xaxs="i",ylab="L-min(L)",xlab="Ro",las=1,main='Erizo zona XI',cex.axis=0.7,cex.main=0.8,cex.lab=0.8)

lines(c(0,TLk2$Ro),rep(2,casos+1),lty=2,lwd=2)
for(i in 2:6){lines(TLk2$Ro,TLk2[,i],col=i,lty=2,lwd=2)}
legend(30,3,names[c(7,2:6)],col=1:7,lty=c(1,rep(2,6)),lwd=2,bty="n",cex=0.7)


```
#### Variables de estado

```{r Fig_VarpoblXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Variables poblacionales de Erizo zona XI", fig.path=dir.Fig,fig.height=6, fig.width=8}


Rt <- ggplot(VarPob) + 
    geom_line(aes(y=Rt3, x=x, colour = "Estimado Zona XI"), size=0.5)+
    geom_ribbon(aes(ymin=lowerRt3, ymax=upperRt3, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Reclutamientos',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BT <- ggplot(VarPob) + 
     geom_line(aes(y=BT3, x=x, colour = "Estimado Zona XI"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBT3, ymax=upperBT3, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Biomasa total',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD3, x=x, colour = "Estimado Zona XI"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft3, x=x, colour = "Estimado Zona XI"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BT|BD/Ft


```

```{r Fig_SelFlotaXI,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=5,fig.align="center",fig.path=dir.Fig,dev=fig, fig.cap="**Figura x**. Selectividad de la flota de la Zona XI"}

age<-rep3$Edades
par(mfrow=c(1,1),mar=c(4,4,1,1))
	plot(age,rep3$Sel_f[1,],type="l",lwd=2,las=1,ylim=c(0,1.1),ylab="Selectividad",xlab="Edad (a√±o)")
	lines(age,rep3$Sel_f[45,],type="o",pch="o")
	legend (6,0.5,c("sel_bloque (1960-2003)","sel_bloque (2004-2020)"),pch=c("","o"),lwd=c(2,1),bty='n',cex=0.8)

```


#### Puntos Biol√≥gicos de Referencia

```{r  Fig_PBRsXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Puntos Biol√≥gicos de referencia de Erizo zona XI", fig.height=7, fig.width=6}

Frms<-dat3$FMRS
BDo<-rep3$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2


BD <- ggplot(VarPob) + 
     geom_line(aes(y=BD3, x=x, colour = "Estimado Zona XI"), size=0.5)+
     geom_ribbon(aes(ymin=lowerBD3, ymax=upperBD3, x=x, fill = "Intervalo de confianza asint√≥tico"), alpha = 0.2)+
   geom_hline(yintercept = c(BDrms,BDlim,BDo),colour=c('green3','red','blue'))+
  annotate("text", x=c(rep(2012,3)), y=c(BDrms,BDlim,BDo),
              label=c(expression("BD"[RMS]),expression("BD"[LIM]),expression("BD"[0]))) +
    labs(x = '', y = 'Biomasa desovante',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

Ft <- ggplot(VarPob) + 
     geom_line(aes(y=Ft3, x=x, colour = "Estimado Zona XI"), size=0.5)+
    geom_ribbon(aes(ymin=lowerFt3, ymax=upperFt3, x=x, fill = ""), alpha = 0.2)+
  geom_hline(yintercept = c(Frms),colour=c('green3')) +
     annotate("text", x=c(2011), y=c(Frms),label=c(expression("F"[RMS]))) +
    labs(x = '', y = 'Mortalidad por pesca',colour='Asesor√≠as')  +
    scale_x_continuous(breaks = seq(from = years[1], to = years[nyears], by = 5)) +
    scale_colour_manual("",values=c("black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BD/Ft


```


#### Indicadores del estatus



#### Estatus del erizo de la Regi√≥n de Ays√©n


```{r Fig_DiagramaFaseXI, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.cap="**Figura x**. Diagrama de fase Erizo zona XI", fig.height=8, fig.width=10}
Zona<- "Erizo Zona XI"
Frms<-dat3$FMRS
BDo<-rep3$BDo
BDrms<-BDo*0.4
BDlim<-BDrms/2

bd_bdrms<-VarPob$BD3/BDrms
f_frms<-VarPob$Ft3/Frms

x.bottom.left <- c(1, 0, 1, 1)
x.top.left    <- c(1, 0, 1, 1)
x.bottom.right<- c(0, 1, 3, 3)
x.top.right   <- c(0, 1, 3, 3)

y.bottom.left <- c(0, 1, 0, 1)
y.bottom.right<- c(0, 1, 0, 1)
y.top.left    <- c( 1, 10,  1, 10)
y.top.right   <- c( 1, 10,  1, 10)

# declare a vector of values
values <- c("1_Sobreexplotaci√≥n","2_Sobreexplotaci√≥n","3_Subexplotaci√≥n","4_Sobrepesca")
# create a data frame containing values and ids
values.df <- data.frame(value = values, id = c(1, 2, 3, 4))
# create the x and y vectors containing the coordinates of each polygon in the correct order
x.coords <- unlist(lapply(1:length(x.bottom.left), function(i) {
    c(x.bottom.left[i], x.bottom.right[i], x.top.right[i], x.top.left[i])
}))
y.coords <- unlist(lapply(1:length(y.bottom.left), function(i) {
    c(y.bottom.left[i], y.bottom.right[i], y.top.right[i], y.top.left[i])
}))
# create a coordinates data frame
coords.df <- data.frame(id = rep(c(1, 2, 3, 4), each = 4), x = x.coords, y = y.coords)
# merge the data frames
data.df <- merge(values.df, coords.df, by = c("id"))



# plot
ggplot() + 
  geom_polygon(data = data.df, aes(x = x, y = y, fill = factor(value), group = id,alpha = 0.9)) +
scale_fill_grey(start=0.4, end=0.9) +
geom_hline(yintercept = 1) + geom_vline(xintercept = c(0.5,1),colour=c(2,1)) +
annotate("text", x=c(0.5,1,3.07), y=c(10.07,10.07,1.07),
              label=c(expression("BD"[LIM]),expression("BD"[RMS]),expression("F"[RMS]))) +
  geom_path(aes(x=bd_bdrms,y=f_frms)) +
  geom_point(aes(x=bd_bdrms,y=f_frms),shape = 21, colour = "black", fill = "white", size = 2.5, stroke = 1)+
  geom_point(aes(x=bd_bdrms[c(nyears,1)],y=f_frms[c(nyears,1)]),shape =c(21,21), colour = c("blue","green"), fill =c("blue4","green4"), size =c(4,4), stroke =c(1,1)) +
   geom_text(aes(x=bd_bdrms,y=f_frms,label=years),angle = 45,nudge_y = 0.15,size = 3) +
labs(x = expression("BD/BD"[RMS]), y = expression("F/F"[RMS]),fill='Estados de explotaci√≥n') +
   theme_bw(base_size=15) +
  ggtitle(Zona)

```

### 6.1.4. An√°lisis integrado de las tres zonas de estudio

# 7. DISCUSI√ìN

# 8. REFERENCIAS
